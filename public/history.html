<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Completed Work - Mission Control</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-left">
        <div class="brand">
          <span class="brand-mark">●</span>
          <h1>Mission Control</h1>
        </div>
        <span class="subtitle">Completed Work</span>
      </div>
      <div class="header-right">
        <a href="/" class="btn btn-secondary btn-sm">← Back to Board</a>
      </div>
    </header>

    <main class="history-page">
      <div class="history-header">
        <h2>Work History</h2>
        <div class="history-filters">
          <select id="businessFilter" class="filter-select">
            <option value="all">All Businesses</option>
          </select>
        </div>
      </div>

      <div class="history-list" id="historyList">
        <!-- Items will be generated by JS -->
      </div>

      <div class="load-more" id="loadMore" style="display: none;">
        <button class="btn btn-secondary btn-sm" id="loadMoreBtn">Load More</button>
      </div>
    </main>
  </div>

  <script>
    let data = { businesses: [], columns: [], tasks: [] };
    let currentFilter = 'all';
    let displayCount = 20;
    const pageSize = 20;

    const historyList = document.getElementById('historyList');
    const businessFilter = document.getElementById('businessFilter');
    const loadMore = document.getElementById('loadMore');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    async function init() {
      const res = await fetch('/api/data');
      data = await res.json();
      populateFilters();
      renderHistory();
    }

    function populateFilters() {
      businessFilter.innerHTML = '<option value="all">All Businesses</option>';
      data.businesses.forEach(b => {
        businessFilter.innerHTML += `<option value="${b.id}">${b.name}</option>`;
      });
    }

    function getFilteredTasks() {
      return data.tasks
        .filter(t => {
          const matchesColumn = t.column === 'done';
          const matchesFilter = currentFilter === 'all' || t.business === currentFilter;
          return matchesColumn && matchesFilter;
        })
        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
    }

    function renderHistory() {
      const allTasks = getFilteredTasks();
      const tasksToShow = allTasks.slice(0, displayCount);

      historyList.innerHTML = '';

      if (tasksToShow.length === 0) {
        historyList.innerHTML = '<div class="empty-state">No completed tasks yet</div>';
        loadMore.style.display = 'none';
        return;
      }

      tasksToShow.forEach(task => {
        const business = data.businesses.find(b => b.id === task.business);
        const item = document.createElement('div');
        item.className = 'history-item';

        const completedDate = new Date(task.updatedAt);
        const dateStr = completedDate.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        item.innerHTML = `
          <div class="history-item-header">
            <div class="history-item-title">${escapeHtml(task.title)}</div>
            <div class="history-item-date">${dateStr}</div>
          </div>
          ${task.outcome ? `
            <div class="history-item-outcome">${linkifyOutcome(task.outcome)}</div>
          ` : ''}
          <div class="history-item-meta">
            <span class="completed-item-business" style="background: ${business?.color || '#64748b'}; color: #fff;">
              ${business?.name || 'Unknown'}
            </span>
            <span class="task-priority ${task.priority}">${task.priority}</span>
          </div>
        `;

        historyList.appendChild(item);
      });

      // Show/hide load more
      loadMore.style.display = displayCount < allTasks.length ? 'block' : 'none';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function linkifyOutcome(text) {
      if (!text) return '';
      const escaped = escapeHtml(text);
      const withBreaks = escaped.replace(/\n/g, '<br>');
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      return withBreaks.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    businessFilter.addEventListener('change', (e) => {
      currentFilter = e.target.value;
      displayCount = pageSize;
      renderHistory();
    });

    loadMoreBtn.addEventListener('click', () => {
      displayCount += pageSize;
      renderHistory();
    });

    // Infinite scroll
    window.addEventListener('scroll', () => {
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
        const allTasks = getFilteredTasks();
        if (displayCount < allTasks.length) {
          displayCount += pageSize;
          renderHistory();
        }
      }
    });

    init();
  </script>
</body>
</html>
